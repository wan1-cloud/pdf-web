<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PDF化ツール</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      line-height: 1.6;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
    }
    #usage {
      margin-bottom: 10px;
      font-size: 14px;
      color: #333;
    }
    #msg {
      margin-top: 10px;
      font-size: 14px;
      color: #d00;
    }
    button {
      margin-top: 8px;
      padding: 6px 16px;
    }
  </style>

  <script>
    const PASSWORD = "yourpassword"; // ← パスワード

    const input = prompt("パスワードを入力してください");
    if (input !== PASSWORD) {
      document.write("アクセス拒否");
      document.close();
      window.stop();
    }
  </script>
</head>

<body>

  <h1>PDF化ツール</h1>

  <div id="usage">データ処理枠：読み込み中...</div>

  <!-- ▼ URL入力欄 -->
  <h2>URLからPDF化</h2>
  <textarea id="urls" rows="10" cols="80" placeholder="1行に1つURLを貼り付けてください"></textarea>
  <br>
  <button id="run">PDF化</button>

  <!-- ▼ 法人番号入力欄 -->
  <h2>法人番号からPDF化</h2>
  <textarea id="corpnos" rows="10" cols="80" placeholder="1行に1つ法人番号（16桁）を入力してください"></textarea>
  <br>
  <button id="run-corp">法人番号PDF化</button>

  <div id="msg"></div>

  <script>
    // Cloud Run のエンドポイント
    const API_BASE = "https://pdf-api-545757591074.asia-northeast1.run.app";
    const GENERATE_ENDPOINT = API_BASE + "/generate";
    const USAGE_ENDPOINT = API_BASE + "/usage";

    // URL入力欄の処理
    function parseUrls(text) {
      return text
        .split(/\r?\n/)
        .map(x => x.trim())
        .filter(x => x.startsWith("http"));
    }

    // 法人番号 → 国税庁URL変換
    function parseCorpNos(text) {
      return text
        .split(/\r?\n/)
        .map(x => x.trim())
        .filter(x => /^\d{16}$/.test(x)) // 16桁の数字のみ
        .map(no => `https://www.houjin-bangou.nta.go.jp/henkorireki-johoto.html?selHouzinNo=${no}`);
    }

    // 使用量取得
    async function loadUsage() {
      const usageEl = document.getElementById("usage");
      try {
        const res = await fetch(USAGE_ENDPOINT);
        if (!res.ok) {
          usageEl.textContent = "データ処理枠：取得エラー";
          return;
        }
        const data = await res.json();
        usageEl.textContent = `データ処理枠：${data.count} / ${data.limit}（今月 ${data.month}）`;
      } catch (e) {
        usageEl.textContent = "データ処理枠：取得エラー";
      }
    }

    // ▼ 共通のPDF生成処理
    async function runPdfGeneration(urls) {
      const msg = document.getElementById("msg");
      msg.style.color = "#333";
      msg.textContent = "処理中...";

      try {
        const res = await fetch(GENERATE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ urls })
        });

        if (res.status === 429) {
          let errMsg = "データ処理枠を超過したため、PDF生成は中止されました。";
          try {
            const data = await res.json();
            if (data && data.message) errMsg = data.message;
          } catch (_) {}
          msg.style.color = "#d00";
          msg.textContent = errMsg;
          loadUsage();
          return;
        }

        const blob = await res.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "pdfs.zip";
        a.click();
        URL.revokeObjectURL(a.href);

        msg.style.color = "#333";
        msg.textContent = "完了";
        loadUsage();

      } catch (e) {
        msg.style.color = "#d00";
        msg.textContent = "通信エラー";
      }
    }

    // ▼ URL PDF化ボタン
    document.getElementById("run").addEventListener("click", async () => {
      const raw = document.getElementById("urls").value;
      const urls = parseUrls(raw);

      const msg = document.getElementById("msg");
      msg.style.color = "#d00";
      msg.textContent = "";

      if (urls.length === 0) {
        msg.textContent = "有効なURLがありません";
        return;
      }

      await runPdfGeneration(urls);
    });

    // ▼ 法人番号 PDF化ボタン
    document.getElementById("run-corp").addEventListener("click", async () => {
      const raw = document.getElementById("corpnos").value;
      const urls = parseCorpNos(raw);

      const msg = document.getElementById("msg");
      msg.style.color = "#d00";
      msg.textContent = "";

      if (urls.length === 0) {
        msg.textContent = "有効な法人番号がありません（16桁の数字のみ有効）";
        return;
      }

      await runPdfGeneration(urls);
    });

    // 初期表示で使用量を読み込む
    loadUsage();
  </script>

</body>
</html>
